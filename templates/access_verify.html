<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Verify Checksum & Download</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
body{ background: radial-gradient(circle at top, #0a0a12, #050507, #020203); color:#d1d1d1; font-family:'Share Tech Mono', monospace; overflow-y:auto; overflow-x:hidden; position:relative; }
#floating-container{ position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:1; }
.panel{ max-width:550px; margin:85px auto; padding:35px; background: rgba(20,20,30,0.65); border-radius:14px; border:2px solid #3a3a3a; box-shadow:0 0 12px #3a9efb44; text-align:center; z-index:10; }
.sha-matte{ word-wrap:break-word; background: rgba(255,255,255,0.04); padding:10px 12px; border-radius:6px; border:1px solid #444; font-size:14px; color:#c9c9c9; display:block; }
input{ background: rgba(255,255,255,0.05); border:1px solid #606060; color:white; width:100%; padding:8px; border-radius:4px; text-align:center; }
.btn-matte{ background:#1a1a1a; color:#d4d4d4; border:1px solid #555; text-transform:uppercase; width:100%; padding:8px; margin-top:8px; }
.btn-confirm{ background:#2e2e2e; color:white; border:1px solid #666; padding:10px 18px; border-radius:6px; display:inline-block; text-decoration:none; }
#status-msg{ margin-top:10px; font-size:14px; }
.form-download{ text-align:center; margin-top:15px; }
</style>

<script>
window.onload=function(){
    // floating icons
    const container=document.createElement('div'); container.id='floating-container'; document.body.appendChild(container);
    const numIcons=40; let icons=[];
    function getContainerHeight(){ return Math.max(document.documentElement.scrollHeight, window.innerHeight); }
    for(let i=0;i<numIcons;i++){
        const icon=document.createElement('i'); icon.className=(i%2===0)?'fas fa-lock':'fas fa-link';
        icon.style.position='absolute'; icon.style.fontSize=(12+Math.random()*16)+'px'; icon.style.opacity=0.3+Math.random()*0.7;
        icon.style.left=Math.random()*(window.innerWidth-20)+'px'; icon.style.top=Math.random()*(getContainerHeight()-20)+'px';
        icon.dx=(Math.random()*0.5+0.1)*(Math.random()<0.5?1:-1); icon.dy=(Math.random()*0.3+0.05)*(Math.random()<0.5?1:-1);
        container.appendChild(icon); icons.push(icon);
    }
    function animateIcons(){ const width=window.innerWidth, height=getContainerHeight(); icons.forEach(icon=>{
        let x=parseFloat(icon.style.left), y=parseFloat(icon.style.top); x+=icon.dx; y+=icon.dy;
        if(x<0){x=0;icon.dx*=-1;} if(x>width-20){x=width-20;icon.dx*=-1;}
        if(y<0){y=0;icon.dy*=-1;} if(y>height-20){y=height-20;icon.dy*=-1;}
        icon.style.left=x+'px'; icon.style.top=y+'px'; if(Math.random()<0.005) icon.style.opacity=0.3+Math.random()*0.7;
    }); requestAnimationFrame(animateIcons); }
    animateIcons();
};
</script>
</head>
<body>
<div class="panel">
<h2>Verify Checksum & Download</h2>

<label>File</label>
<p><strong>{{ file_name }}</strong></p>

<label>Expected SHA-256 Checksum</label>
<p id="expectedChecksum" class="sha-matte">{{ checksum }}</p>

<input type="text" id="userChecksum" placeholder="Enter checksum to verify" class="mb-2">
<button type="button" class="btn-matte" onclick="onVerify()">Verify Checksum</button>

<div id="status-msg"></div>

<div class="form-download">
    <form method="GET" action="{{ url_for('download', token=token) }}">
        <button id="downloadBtn" type="submit" class="btn-confirm" disabled>Download File</button>
    </form>
</div>
</div>

<script>
function onVerify(){
    const entered = document.getElementById("userChecksum").value.trim();
    const status = document.getElementById("status-msg");
    const downloadBtn = document.getElementById("downloadBtn");
    // send AJAX POST to server to verify (server will set session flag)
    const params = new URLSearchParams();
    params.append("userChecksum", entered);
    fetch(window.location.pathname + window.location.search, {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded"},
        body: params.toString()
    }).then(r => r.json()).then(data => {
        if (data && data.success) {
            status.textContent = "Checksum verified â€” download enabled.";
            status.style.color = "lightgreen";
            downloadBtn.disabled = false;
        } else {
            status.textContent = "Checksum does NOT match.";
            status.style.color = "salmon";
            downloadBtn.disabled = true;
        }
    }).catch(err=>{
        status.textContent = "Verification failed (network/server).";
        status.style.color = "salmon";
        downloadBtn.disabled = true;
    });
}
</script>
</body>
</html>
